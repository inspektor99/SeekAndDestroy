/*! SeekAndDestroy 2014-05-07 */
!function(){window.console||alert("your browser sucks and cannot run this site"),window.WebSocket||alert("again, your browser sucks and cannot run this awesome site.  we will now spam your browser with errors. prepare to die.")}();var Sad={GameStates:{Stopped:0,Started:1,FinalScore:2},gameState:null,TARGET_COUNT:4,TIME_WARNING:3e3,TIME_DANGER:4500,TIME_LIMIT:6e3,currentTeam:null,teams:null,setGameOver:null};$(function(){Sad.gameState=Sad.GameStates.Stopped,Sad.teams=new Sad.Teams;var a=io.connect("http://localhost:3000");$("#statusGameServer").tooltip({placement:"bottom"}),$("#resetAll").tooltip({placement:"bottom"});var b=function(){$.get("/connect?ip="+$("#raspPiAddress").val())};$("#resetAll").on("click",function(){return $.get("/reset"),!1}),$("#statusGameServer").on("click",function(){return b(),!1}),$("#generalSetup").on("click",function(){return $("#generalSetupWindow").modal(),!1}),$("#piConnect").on("click",function(){return $("#generalSetupWindow").modal("hide"),b(),!1}),a.on("connectedrpi",function(){$("#statusGameServer").removeClass("btn-default btn-success btn-danger btn-warning").addClass("btn-success")}),a.on("connecterror",function(){$("#statusGameServer").removeClass("btn-default btn-success btn-danger btn-warning").addClass("btn-danger"),d()}),a.on("startgame",function(a){if(Sad.gameState===Sad.GameStates.FinalScore&&(Sad.gameState=Sad.GameStates.Stopped,e()),Sad.gameState===Sad.GameStates.Stopped){$("#timer").removeClass("text-warning"),$("#timer").removeClass("text-danger"),$("#timer").addClass("text-info");var b=new Sad.Team;b.set("name",a.teamname),Sad.addTeam(b),b=Sad.setCurrentTeam(a.teamname),b.addNewGame(a.gamename,a.targets),$("#currteam").text(Sad.currentTeam.get("name")),$("#currgame").text(a.gamename);var c=Sad.currentTeam.getCurrentGame();Sad.updateTargets(a.targets),c.set("start",(new Date).getTime()),$("#welcome").hide(),$("#scoreboard").slideDown("slow"),Sad.Timer.start(),$("#music")[0].volume=.08,$("#music")[0].play(),Sad.gameState=Sad.GameStates.Started}return!1}),a.on("targethit",function(a){if(Sad.gameState===Sad.GameStates.Started){Sad.updateTargets(a.targets);var b=Sad.currentTeam.getCurrentGame();$("#t1_type, #t2_type, #t3_type, #t4_type").removeClass(),$("#t1_type, #t2_type, #t3_type, #t4_type").addClass("muted");var c=0;b.get("targets").each(function(a){c+=parseFloat(a.get("points"))*parseInt(a.get("hit")),$("#t"+a.get("id")+"_hit").val(a.get("hit"));var b=$("#t"+a.get("id")+"_type");b.removeClass();var d=a.get("status");1===d?b.addClass("text-success"):0===d?b.addClass("text-error"):2===d&&b.addClass("muted")}),$("#teamScore").text()!==c.toString()&&(Sad.playBomb(),$("#teamScore").text(c))}}),a.on("stopgame",function(a){return c(a),!1});var c=function(){if(Sad.gameState===Sad.GameStates.Started){var a=Sad.currentTeam.getCurrentGame();a.set("score",parseInt($("#teamScore").text())),$("#finalscorewindow").modal(),Sad.Timer.stop(),a.set("end",(new Date).getTime()),$("#music")[0].pause(),$("#music")[0].currentTime=0,a.set("endDisplay",$("#timer").text()),$("#resultTeamName").html(Sad.currentTeam.get("name")),$("#inputTime").val(a.get("endDisplay")),$("#inputFinalscore").val(a.get("score")),$("#inputGamenotesEnd").val(a.get("notes")),Sad.gameState=Sad.GameStates.FinalScore}},d=function(){if($("#music")[0].pause(),$("#music")[0].currentTime=0,Sad.Timer.reset(),$("#scoreboard").hide(),$("#welcome").slideDown("slow"),$("#finalscorewindow").modal("hide"),$("#teamScore").html("0"),null!==Sad.currentTeam){var a=Sad.currentTeam.getCurrentGame();a.get("targets").each(function(a){$("#t"+a.get("id")+"_hit").val("0");var b=$("#t"+a.get("id")+"_type");b.removeClass(),b.addClass("muted")})}if(Sad.teams.length>0){var b=Sad.teams.sortBy(function(a){return-1*a.getBestGame().get("score")});$("#welcome table").remove();var c=$('<table class="table table-striped"><thead><th><h3>Team</h3></th><th><h3>Best Score</h3></th></thead><tbody></tbody></table>');$("#welcome").append(c),_.each(b,function(a){var b=a.getBestGame();c.find("tbody").append("<tr><td><h4>"+a.get("name")+"</h4></td><td><h4>"+b.get("score")+"</h4></td></tr>")})}Sad.gameState=Sad.GameStates.Stopped};a.on("reset",function(){d()}),a.on("timeover",function(a){c(a)});var e=function(){var a=Sad.currentTeam.getCurrentGame();a.get("targets").each(function(a){var b=$("#t"+a.get("id")+"_hit").val();a.set("hit",parseInt(b))});var b=$("#inputFinalscore").val();a.set("score",parseInt(b)),a.set("notes",$("#inputGamenotesEnd").val()),d()};$("#finish").on("click",function(){return Sad.gameState===Sad.GameStates.FinalScore&&e(),!1})}),Sad.playBomb=function(){Sad.gameState===Sad.GameStates.Started&&($("#bomb")[0].volume=1,$("#bomb")[0].pause(),$("#bomb")[0].currentTime=0,$("#bomb")[0].play())},Sad.updateTargets=function(a){var b=Sad.currentTeam.getCurrentGame();b.setTargets(a),$("#t1_counter, #t2_counter, #t3_counter, #t4_counter").removeClass(),$("#t1_counter, #t2_counter, #t3_counter, #t4_counter").addClass("badge"),$("#t1_counter>span, #t2_counter>span, #t3_counter>span, #t4_counter>span").text("X"),b.get("targets").each(function(a){var b=$("#t"+a.get("id")+"_counter");$("span",b).text(a.get("hit"));var c=a.get("status");b.removeClass(),1===c?b.addClass("badge badge-success"):0===c?b.addClass("badge badge-important"):2===c&&b.addClass("badge")})},Sad.Target=Backbone.Model.extend({defaults:{id:0,status:2,hit:0},initialize:function(){}}),Sad.Targets=Backbone.Collection.extend({model:Sad.Target}),Sad.addTeam=function(a){var b=!0;return this.teams.each(function(c){c.get("name").toLowerCase()===a.get("name").toLowerCase()&&(b=!1)}),b&&(a.get("games").reset(),this.teams.add(a)),b},Sad.setCurrentTeam=function(a){var b=null;return this.teams.each(function(c){c.get("name").toLowerCase()===a.toLowerCase()&&(Sad.currentTeam=c,b=c)}),b},Sad.Team=Backbone.Model.extend({defaults:{name:null,ip:null,score:0,games:null},initialize:function(){this.set("games",new Sad.Games)},addNewGame:function(a,b){var c=new Sad.Game;return c.set("code",a),c.setTargets(b),this.get("games").add(c),c},getCurrentGame:function(){return this.get("games").at(this.get("games").length-1)},getBestGame:function(){return this.get("games").max(function(a){return a.get("score")})}}),Sad.Teams=Backbone.Collection.extend({model:Sad.Team}),Sad.Game=Backbone.Model.extend({defaults:{code:null,start:0,end:0,endDisplay:"0:00:00",targets:null,score:0,notes:null},initialize:function(){this.set("targets",new Sad.Targets)},setTargets:function(a){this.get("targets").reset(a)}}),Sad.Games=Backbone.Collection.extend({model:Sad.Game}),Sad.Timer={DEFAULT_DISPLAY:"0:00:000",id:null,tick:0,elem:$("#timer")[0],isRunning:function(){return null!==this.id},start:function(){this.id=window.setInterval(this.setTick,10)},setTick:function(){Sad.Timer.tick++;var a=Sad.Timer.tick%100,b=Math.floor(Sad.Timer.tick/100),c=Math.floor(b/60);b%=60,10>a&&(a="0"+a.toString()),10>b&&(b="0"+b.toString()),Sad.Timer.elem.innerHTML=c+":"+b+":"+a,Sad.Timer.tick===Sad.TIME_WARNING&&($("#timer").removeClass("text-info"),$("#timer").addClass("text-warning")),Sad.Timer.tick===Sad.TIME_DANGER&&($("#timer").removeClass("text-warning"),$("#timer").addClass("text-danger")),Sad.Timer.tick===Sad.TIME_LIMIT&&($.get("/timeover"),Sad.Timer.stop())},stop:function(){null!==Sad.Timer.id&&(window.clearInterval(Sad.Timer.id),Sad.Timer.id=null)},reset:function(){Sad.Timer.stop(),Sad.Timer.tick=0,Sad.Timer.elem.innerHTML=Sad.Timer.DEFAULT_DISPLAY},getTick:function(){return this.tick}};