/*! SeekAndDestroy 2013-11-27 */
!function(){window.console||alert("your browser sucks and cannot run this site"),window.WebSocket||alert("again, your browser sucks and cannot run this awesome site.  we will now spam your browser with errors. prepare to die.")}();var Sad={TARGET_COUNT:4,TIME_WARNING:6e3,TIME_DANGER:9e3,TIME_LIMIT:12e3,currentTeam:null,teams:[]},SockServer=Backbone.Model.extend({defaults:{ip:"10.0.0.4",port:"4500",socket:null,connected:!1,statusButton:null,respCallback:null,uri:""},init:function(a){if(!this.get("statusButton"))return console.log("no button to update so assuming no connection"),void 0;this.get("statusButton").removeClass(),this.get("statusButton").addClass("btn btn-warning");var b=new WebSocket("ws://"+this.get("ip")+":"+this.get("port")+"/"+this.get("uri")),c=this;b.onopen=function(){c.get("statusButton").removeClass(),c.get("statusButton").addClass("btn btn-success"),console.log("connected to "+c.get("ip")+":"+c.get("port")),c.set("connected",!0),a&&a()},b.onmessage=function(a){console.log(c.get("ip")+" message "+a.data);var b=JSON.parse(a.data);Sad.Timer.isRunning()&&(Sad.playBomb(),Sad.updateTargets(b)),c.get("respCallback")&&(c.get("respCallback")(b),c.set("respCallback",null))},b.onclose=function(){c.get("statusButton").removeClass(),c.get("statusButton").addClass("btn btn-danger"),console.log(c.get("ip")+" socket closed."),c.set("connected",!1)},b.onerror=function(a){console.log(c.get("ip")+" there was an error"),console.log(a)},this.set("socket",b)},send:function(a,b){if(this.get("connected")){this.set("respCallback",b);var c=JSON.stringify(a);console.log(this.get("ip")+" sending message\n"+c),this.get("socket").send(c)}else console.log(this.get("ip")+" not connected so no message sent")}}),ClassServer=new SockServer,RPiServer=new SockServer;$(function(){RPiServer.set({ip:"10.0.0.4",port:"4500",statusButton:$("#statusPi"),uri:"ws"}),RPiServer.init(),$("#statusLaptop").tooltip({placement:"bottom"}),$("#statusPi").tooltip({placement:"bottom"}),$("#statusLaptop").on("click",function(){return ClassServer.init(),!1}),$("#statusPi").on("click",function(){return RPiServer.init(),!1}),$("#viewStats").on("click",function(){$("#statswindow").modal();var a=$("#statsTable");return 0===Sad.teams.length?a.hide():(a.show(),Sad.loadStats(a)),!1}),$("#setup").on("click",function(){$("#setupwindow").modal();var a=function(a){console.log(a)};RPiServer.send({getgames:null},a)}),$("#begin").on("click",function(){var a=function(a){$("#timer").removeClass("text-warning"),$("#timer").removeClass("text-error"),$("#timer").addClass("text-info");var b=new Sad.Team;b.set("name",$("#inputTeamname").val()),b.set("ip",$("#inputTeamIP").val()),Sad.addTeam(b),b=Sad.setCurrentTeam(b.get("name")),b.addNewGame($("#inputGamecode").val(),a),$("#currteam").text(Sad.currentTeam.get("name"));var c=Sad.currentTeam.getCurrentGame();c.set("notes",$("#inputGamenotesStart").val()),Sad.updateTargets(a),c.set("start",(new Date).getTime()),$("#setupwindow").modal("hide"),$("#welcome").hide(),$("#scoreboard").slideDown("slow"),ClassServer.send(Sad.currentTeam),Sad.Timer.start(),$("#music")[0].volume=.5,$("#music")[0].play()};return RPiServer.send({startgame:$("#inputGamecode").val()},a),!1}),$("#manualdone").on("click",function(){var a=Sad.currentTeam.getCurrentGame();return $("#finalscorewindow").modal(),Sad.Timer.stop(),a.set("end",(new Date).getTime()),$("#music")[0].pause(),$("#music")[0].currentTime=0,a.set("endDisplay",$("#timer").text()),$("#resultTeamName").html(Sad.currentTeam.get("name")),$("#inputTime").val(a.get("endDisplay")),$("#inputFinalscore").val(a.get("score")),$("#inputGamenotesEnd").val(a.get("notes")),$("#t1_type, #t2_type, #t3_type, #t4_type").removeClass(),$("#t1_type, #t2_type, #t3_type, #t4_type").addClass("muted"),_.each(a.get("targets"),function(a){$("#t"+a.get("id")+"_hit").val(a.get("hit"));var b=$("#t"+a.get("id")+"_type");b.removeClass();var c=a.get("status");1===c?b.addClass("text-success"):0===c?b.addClass("text-error"):2===c&&b.addClass("muted")}),!1}),$("#finish").on("click",function(){Sad.Timer.reset(),$("#scoreboard").hide(),$("#welcome").slideDown("slow"),$("#finalscorewindow").modal("hide");var a=Sad.currentTeam.getCurrentGame();_.each(a.get("targets"),function(a){var b=$("#t"+a.get("id")+"_hit").val();a.set("hit",parseInt(b))});var b=$("#inputFinalscore").val();return a.set("score",parseInt(b)),a.set("notes",$("#inputGamenotesEnd").val()),!1})}),Sad.playBomb=function(){$("#bomb")[0].volume=1,$("#bomb")[0].pause(),$("#bomb")[0].currentTime=0,$("#bomb")[0].play()},Sad.loadStats=function(a){var b=0,c=this.teams.length;for($("tbody",a).html(""),b=0;c>b;b++){var d=this.teams[b].toJSON();$("tbody",a).append("<tr><td></td><td>"+d.name+"</td><td>"+d.games.length+"</td><td></td></tr>")}},Sad.updateTargets=function(a){var b=Sad.currentTeam.getCurrentGame();b.setTargets(a),ClassServer.send(Sad.currentTeam),$("#t1_counter, #t2_counter, #t3_counter, #t4_counter").removeClass(),$("#t1_counter, #t2_counter, #t3_counter, #t4_counter").addClass("badge"),$("#t1_counter>span, #t2_counter>span, #t3_counter>span, #t4_counter>span").text("X"),_.each(b.get("targets"),function(a){var b=$("#t"+a.get("id")+"_counter");$("span",b).text(a.get("hit"));var c=a.get("status");b.removeClass(),1===c?b.addClass("badge badge-success"):0===c?b.addClass("badge badge-important"):2===c&&b.addClass("badge")})},Sad.Target=Backbone.Model.extend({defaults:{id:0,status:2,hit:0}}),Sad.addTeam=function(a){var b=!0;return _.each(this.teams,function(c){c.get("name").toLowerCase()===a.get("name").toLowerCase()&&(b=!1)}),b&&(a.set("games",[]),this.teams.push(a)),b},Sad.setCurrentTeam=function(a){var b=null;return _.each(this.teams,function(c){c.get("name").toLowerCase()===a.toLowerCase()&&(Sad.currentTeam=c,b=c)}),b},Sad.Team=Backbone.Model.extend({defaults:{name:null,ip:null,score:0,games:[]},addNewGame:function(a,b){var c=new Sad.Game;return c.set("code",a),c.setTargets(b),this.get("games").push(c),c},getCurrentGame:function(){return this.get("games")[this.get("games").length-1]}}),Sad.Game=Backbone.Model.extend({defaults:{code:null,start:0,end:0,endDisplay:"0:00:00",targets:null,score:0,notes:null},setTargets:function(a){this.set("targets",[]);var b=0;for(b=0;b<a.length;b++){var c=new Sad.Target;c.set(a[b]),this.get("targets").push(c)}}}),Sad.Timer={DEFAULT_DISPLAY:"0:00:000",id:null,tick:0,elem:$("#timer")[0],isRunning:function(){return null!==this.id},start:function(){this.id=window.setInterval(this.setTick,10)},setTick:function(){Sad.Timer.tick++;var a=Sad.Timer.tick%100,b=Math.floor(Sad.Timer.tick/100),c=Math.floor(b/60);b%=60,10>a&&(a="0"+a.toString()),10>b&&(b="0"+b.toString()),Sad.Timer.elem.innerHTML=c+":"+b+":"+a,Sad.Timer.tick===Sad.TIME_WARNING&&($("#timer").removeClass("text-info"),$("#timer").addClass("text-warning")),Sad.Timer.tick===Sad.TIME_DANGER&&($("#timer").removeClass("text-warning"),$("#timer").addClass("text-danger")),Sad.Timer.tick===Sad.TIME_LIMIT&&Sad.Timer.stop()},stop:function(){null!==Sad.Timer.id&&(window.clearInterval(Sad.Timer.id),Sad.Timer.id=null)},reset:function(){Sad.Timer.stop(),Sad.Timer.tick=0,Sad.Timer.elem.innerHTML=Sad.Timer.DEFAULT_DISPLAY},getTick:function(){return this.tick}};